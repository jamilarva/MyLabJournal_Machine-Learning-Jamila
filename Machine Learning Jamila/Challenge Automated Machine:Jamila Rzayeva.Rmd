---
title: "Challenge - Automated Machine Learning with H2O"
author: "Jamila Rzayeva"
date: "2022-06-12"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 2
    #code_folding: hide
---

```{css, echo=FALSE}
body {
  color: white;
  background-color: #ffc1cc;
  font-family: Futura;
}
.list-group-item, .list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
  color: white;
  background-color: #ff758d ;
  border-color: #white;
  border-width: 5px;
}
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE,
    warning = FALSE
    )
```

# Challenge One
Load the following libraries. 
```{r, fig.height= 8 }
library(tidyverse)
library(readxl)
library(skimr)
library(GGally)
library(DT)

# <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3
library("wesanderson") # <3 <3 <3 <3 <3 <3 <3 <3 <3 
# <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3 <3

# Table Help
color <- toString(wes_palette("GrandBudapest2", 4)[4])
longString = paste("$(this.api().table().header()).css({'color':'#ffff', 'background-color' : '", 
                   color, 
                   "'});") #Format the table header

pretty.tables <- function(tb1) {
    datatable(tb1, class = 'cell-border stripe', 
              rownames = FALSE,
              options = list(
                initComplete = JS(
                  "function(settings, json) {", 
                  longString ,
                  "}")))
}

attrition_tb1 <- read_csv("raw_data/HR-Employee-Attrition.csv")
definitions_raw_tbl   <- read_excel("raw_data/data_definitions.xlsx", 
                                    sheet = 1, 
                                    col_names = FALSE)
```

###  Descriptive Features
```{r, fig.height= 8 }
pretty.tables(attrition_tb1 %>% select(Age, DistanceFromHome, Gender, MaritalStatus, NumCompaniesWorked, Over18))
```

###  Employment Features
```{r, fig.height= 8 }
pretty.tables(attrition_tb1 %>% select(Department, EmployeeCount, EmployeeNumber, JobInvolvement, JobLevel, JobRole, JobSatisfaction))
```

### Compensation  Features
```{r, fig.height= 8 }
pretty.tables(attrition_tb1 %>% select(DailyRate, HourlyRate, MonthlyIncome, MonthlyRate, PercentSalaryHike, StockOptionLevel))
```

### Survery  Features
```{r, fig.height= 8 }
pretty.tables(attrition_tb1 %>% select(EnvironmentSatisfaction, JobSatisfaction, RelationshipSatisfaction, WorkLifeBalance))
```

### Performance  Features
```{r, fig.height= 8 }
pretty.tables(attrition_tb1 %>% select(JobInvolvement, PerformanceRating))
```

### Work-Life  Features
```{r, fig.height= 8 }
pretty.tables(attrition_tb1 %>% select(BusinessTravel, OverTime))
```

### Time-Based Features
```{r, fig.height= 8 }
pretty.tables(attrition_tb1 %>% select(Education, EducationField, TrainingTimesLastYear))
```

### Time-Based Features
```{r, fig.height= 8 }
pretty.tables(attrition_tb1 %>% select(TotalWorkingYears, YearsAtCompany, YearsInCurrentRole, YearsSinceLastPromotion, YearsWithCurrManager))
```

##Step 1: Data Overview
```{r, fig.height= 8 }
skim(attrition_tb1)

#char data types
attrition_tb1 %>% select_if(is.character) %>% glimpse()

#levels
attrition_tb1 %>% select_if(is.character) %>% map(unique)

#proportions    
attrition_tb1 %>% select_if(is.character) %>% map(~ table(.) %>% prop.table())

#numeric data
attrition_tb1 %>% select_if(is.numeric) %>% map(~ unique(.) %>% length())
attrition_tb1 %>% select_if(is.numeric) %>%
                  map_df(~ unique(.) %>% 
                  length()) %>%
                  #all columns
                  pivot_longer(everything()) %>%
                  arrange(value) %>%
                  filter(value <= 10) %>%
                  pretty.tables()
```

## Step 2: Visualization
```{r, fig.height= 8 }
attrition_tb1 %>% select(Attrition, 
                         Age, 
                         Gender, 
                         MaritalStatus, 
                         NumCompaniesWorked, 
                         Over18, 
                         DistanceFromHome) %>%
                    ggpairs() 

# Basic Plot
attrition_tb1 %>% select(Attrition, 
                         Age, 
                         Gender, 
                         MaritalStatus, 
                         NumCompaniesWorked, 
                         Over18, 
                         DistanceFromHome) %>%
                  ggpairs(aes(color = Attrition), lower = "blank", legend = 1,
                          diag  = list(continuous = wrap("densityDiag", alpha = 0.5))) +
                  theme(legend.position = "bottom")

data <- attrition_tb1 %>% select(Attrition, 
                                 Age, 
                                 Gender, 
                                 MaritalStatus, 
                                 NumCompaniesWorked, 
                                 Over18, 
                                 DistanceFromHome)

# Plot Helper Function
plot_ggpairs <- function(data, color = NULL, dalph = 0.5) {
    color_expr <- enquo(color)
    if (rlang::quo_is_null(color_expr)) {
        g <- data %>%
            ggpairs(lower = "blank") 
    } else {
        color_name <- quo_name(color_expr)
        g <- data %>% ggpairs(mapping = aes_string(color = color_name), 
                              lower = "blank", legend = 1,
                              diag = list(continuous = wrap("densityDiag", 
                              alpha = dalph))) +
                      theme(legend.position = "bottom")
    }
    return(g)
}

#Look how pretty with colors
attrition_tb1 %>% select(Attrition, 
                         Age, 
                         Gender, 
                         MaritalStatus, 
                         NumCompaniesWorked, 
                         Over18, 
                         DistanceFromHome) %>%
                  plot_ggpairs(color = Attrition)
```

## Apply to Features 
### Descriptive Features
```{r, fig.height= 8 }
attrition_tb1 %>% select(Attrition, 
                         Age, 
                         Gender, 
                         MaritalStatus, 
                         NumCompaniesWorked, 
                         Over18, 
                         DistanceFromHome) %>% 
                  plot_ggpairs(Attrition)
```

### Employment Features
```{r, fig.height= 8 }
attrition_tb1 %>% select(Attrition, 
                         contains("employee"), 
                         contains("department"), 
                         contains("job")) %>%
                   plot_ggpairs(Attrition) 
```

### Compensation  Features
```{r, fig.height= 8 }
attrition_tb1 %>% select(Attrition, 
                         contains("income"), 
                         contains("rate"), 
                         contains("salary"), 
                         contains("stock")) %>%
                  plot_ggpairs(Attrition)
```

### Survery  Features
```{r, fig.height= 8 }
attrition_tb1 %>% select(Attrition, contains("satisfaction"), contains("life")) %>%
                  plot_ggpairs(Attrition)
```

### Performance  Features
```{r, fig.height= 8 }
attrition_tb1 %>% select(Attrition, contains("performance"), contains("involvement")) %>%
                  plot_ggpairs(Attrition)
```

### Work-Life  Features
```{r, fig.height= 8 }
attrition_tb1 %>% select(Attrition, contains("overtime"), contains("travel")) %>%
                  plot_ggpairs(Attrition)
```

### Training and Education
```{r, fig.height= 8 }
attrition_tb1 %>% select(Attrition, contains("training"), contains("education")) %>%
                  plot_ggpairs(Attrition)
```

### Time-Based Features
```{r, fig.height= 8 }
attrition_tb1 %>% select(Attrition, contains("years")) %>%
                  plot_ggpairs(Attrition)
```

# Challenge Two
## Preperation
```{r, fig.height= 8 }
#Import Libraries
library(rsample)
library(recipes)
library(tidyverse)
library(readxl)
library(h2o)

#Load Data
backorders_tb1 <- read_csv("C:/Users/alexa/Documents/Germany/Hamburg2020/TUHH/SuSe 2021/BWL/ml_journal-adarche/raw_data/product_backorders.csv")
```
## Step 1: Load the training and test datasets
```{r, fig.height= 8 }
# Divide into test and train
set.seed(seed = 1349)
split_obj <- rsample::initial_split(backorders_tb1, prop = 0.75)

# Assign test and train
train_readable_tb1 <- training(split_obj)
test_readable_tb1  <- testing(split_obj)

factor_names <- c("went_on_backorder")
recipie <- recipe(went_on_backorder ~ ., data = train_readable_tb1) %>%  
           step_zv(all_predictors()) %>% 
           step_mutate_at(factor_names, fn = as.factor) %>%
           step_center(all_numeric()) %>%
           step_scale(all_numeric()) %>%
           step_dummy(all_nominal(), -all_outcomes()) %>% 
           prep()

training <- bake(recipie, new_data = train_readable_tb1)
testing  <- bake(recipie, new_data = test_readable_tb1)
```

## Step 2: Specifiy the response and predictor variables
```{r, fig.height= 8 }
h2o.init()
split_h2o <- h2o.splitFrame(as.h2o(training), ratios = c(0.75), seed = 1435)
train_h2o <- split_h2o[[1]]
valid_h2o <- split_h2o[[2]]
test_h2o  <- as.h2o(testing)

y <- "went_on_backorder"
x <- setdiff(names(train_h2o), y)
```
## Step 3: Run AutoML specifying the stopping criterion
```{r, fig.height= 8 }
# Run AutoML
h2o_model <- h2o.automl(x = x,
                                y = y,
                                training_frame    = train_h2o,
                                validation_frame  = valid_h2o,
                                leaderboard_frame = test_h2o,
                                max_runtime_secs  = 30,
                                nfolds            = 5)
```
## Step 4: View the leaderboard
```{r, fig.height= 8 }
#Display relevant information
typeof(h2o_model)
slotNames(h2o_model)
h2o_model@leaderboard 
```
## Step 5: Predicting using Leader Model
```{r, fig.height= 8 }
#Make Predictions
h2o_model@leader 
pred_tb1 <- h2o.predict(h2o_model@leader, newdata = as.h2o(testing)) %>% 
            as_tibble()
```
## Step 6: Save the leader model
```{r, fig.height= 8 }
h2o_model@leader %>% h2o.saveModel(path ="raw_data/")
```